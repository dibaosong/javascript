
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<!--[if lt IE 9]>
<script type="text/javascript" src="http://www.sycalc.com.cn:8082/lib/html5shiv.js"></script>
<script type="text/javascript" src="http://www.sycalc.com.cn:8082/lib/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="http://www.sycalc.com.cn:8082/static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="http://www.sycalc.com.cn:8082/static/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
<link rel="stylesheet" type="text/css" href="http://www.sycalc.com.cn:8082/static/h-ui.admin/skin/default/skin.css" id="skin" />
<link rel="stylesheet" type="text/css" href="http://www.sycalc.com.cn:8082/static/h-ui.admin/css/style.css" />
<!--[if IE 6]>
<script type="text/javascript" src="http://www.sycalc.com.cn:8082/lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<title>分组列表</title>

<style>
	body{
		height: 100%;
	}
	.page-container{
		height: calc(100% - 40px);
	}
	.group-box{
		height: calc(100% - 80px);
		border: 1px #e5e5e5 solid;
		box-shadow: 0 0 5px #ccc;
	}
	.group-left{
		float: left;
		width: 170px;
		height: 100%;
		background: #f5f5f5;
		box-shadow: 0 0 2px #ccc inset;
		overflow-x: hidden;
		overflow-y: auto; 
	}
	.group-left li{
		position: relative;
		height: 70px;
		line-height: 70px;
		text-indent: 15px;
		border-top: 1px #f5f5f5 solid;
		border-bottom: 1px #f5f5f5 solid;
		cursor: pointer;
		white-space:nowrap;word-break:keep-all;text-overflow:ellipsis;overflow:hidden;
	}
	.group-left li i{
		transition: .3s;
		opacity: 0;
		position: absolute;
		right: 3px;
		top: 3px;
		width: 20px;
		height: 20px;
		text-indent: 0;
		text-align: center;
		line-height: 20px;
		background: #5a98de;
		border-radius: 15px;
		color: #fff;
		cursor: pointer;
	}
	.group-left li:hover i{
		opacity: 1;
	}
	.group-left li:first-child{
		border-top: 0 !important;
	}
	.group-left li.active{
		width: 100%;
		border-right: 1px #fff solid;
		border-top: 1px #e5e5e5 solid;
		border-bottom: 1px #e5e5e5 solid;
		background: #fff;
		cursor: default;
	}
	.group-right{
		float: right;
		width: calc(100% - 170px);
		height: 100%;
	}
	.group-cons{
		display: none;
		height: 100%;
	}
	.group-con{
		height: calc(100% - 50px);
		padding: 0 30px;
		overflow: auto;
	}
	.group-conbox{
		padding: 20px 0 10px 0;
	}
	.group-conbox .btn{
		margin: 0 15px 15px 0;
		cursor: default;
	}
	.group-conbox i{
		margin-left: 5px;
		cursor: pointer;
	}
	.group-footer{
		height: 50px;
		line-height: 50px;
		background: #e4e4e4;
	}
	.group-project-text{
		width: 300px;
	}
	.group-project-con{
		width: 350px;
		min-height: 120px;
		max-height: 200px;
		margin: 20px auto;
		padding: 5px 20px 20px 20px;
		border: 1px #e5e5e5 solid;
		overflow: auto;
	}
	.group-project-con .cl{
		margin-top: 10px;
	}
	.group-project-con label{
		vertical-align: middle;
	}
</style>

</head>

<body>
	<div class="page-container">
		<button class="btn btn-primary radius" id="createGroupBtn">
			<i class="Hui-iconfont"></i> 创建分组
		</button>
		<div class="group-box mt-20">
			<ul class="group-left" id="groupList">
				<li data-year="2019" data-id="1"><span title="分组1分组1分组1分组1分组1分组1分组1">分组1分组1分组1分组1分组1分组1分组1</span><i title="删除分组" class="Hui-iconfont js-group-delete">&#xe6a6</i></li>
				<li data-year="2019" data-id="2">分组2<i title="删除分组" class="Hui-iconfont js-group-delete">&#xe6a6</i></li>
			</ul>
			<div class="group-right" id="groupShow">
				<div class="group-cons">
					<div class="group-con">
						<div class="group-conbox">
							<button data-id="1" data-name="子项目1" data-money="100" class="js-project btn btn-primary-outline radius" type="button">子项目1 <i class="Hui-iconfont js-project-delete">&#xe6a6</i></button>
						</div>
						<button class="btn btn-primary radius js-add-project">
							<i class="Hui-iconfont"></i> 添加项目
						</button>
					</div>
					<div class="group-footer text-r">
						分组年份：<span class="mr-10">2019</span> 计项目数量：<span class="mr-10 js-count">1</span> 合计金额：<span class="js-money">100</span>（万元）
					</div>
				</div>
				<div class="group-cons">
					<div class="group-con">
						<div class="group-conbox"></div>
						<button class="btn btn-primary radius js-add-project">
							<i class="Hui-iconfont"></i> 添加项目
						</button>
					</div>
					<div class="group-footer text-r">
						分组年份：<span class="mr-10">2019</span> 计项目数量：<span class="mr-10 js-count">0</span> 合计金额：<span class="js-money">0</span>（万元）
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 创建分组 -->
	<div class="modal fade" id="groupModal">
		<div class="modal-dialog">
			<div class="modal-content radius">
				<div class="modal-header">
					<h3 class="modal-title">创建分组</h3>
					<a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
				</div>
				<div class="modal-body">
					<form class="form">
						<div class="row cl">
							<label class="form-label col-xs-4 text-r"><span class="c-red">*</span>分组名称：</label>
							<div class="formControls col-xs-6">
								<input id="groupName" type="text" class="input-text" name="name">
							</div>
						</div>
						<div class="row cl">
							<label class="form-label col-xs-4 text-r"><span class="c-red">*</span>分组年份：</label>
							<div class="formControls col-xs-6">
								<input id="groupYear" type="text" class="input-text" name="year">
							</div>
						</div>
						<div class="row cl">
							<label class="form-label col-xs-4 text-r"><span class="c-red">*</span>部门：</label>
							<div class="formControls col-xs-6">
								<div class="select-box">
									<select id="bmSelect" class="select"></select>
								</div>
							</div>
						</div>
						<div class="row cl">
							<label class="form-label col-xs-4 text-r"><span class="c-red">*</span>分管领导：</label>
							<div class="formControls col-xs-6">
								<div class="select-box">
									<select id="fgldSelect" class="select"></select>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button class="btn btn-primary" id="groupConfirm">确定</button>
					<button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 添加项目 -->
	<div class="modal fade" id="projectModal">
		<div class="modal-dialog">
			<div class="modal-content radius">
				<div class="modal-header">
					<h3 class="modal-title">添加项目</h3>
					<a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
				</div>
				<div class="modal-body">
					<div class="row cl text-c">
						<input id="projectInput" type="text" class="input-text group-project-text" name="name">
						<button id="projectSearch" class="btn btn-primary" type="button">
							<i class="Hui-iconfont"></i> 搜项目
						</button>
					</div>
					<div class="group-project-con" id="projectCheck"></div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-primary" id="projectConfirm">确定</button>
					<button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
				</div>
			</div>
		</div>
	</div>
	

	<input type="hidden" id="token" value="98CpjDMLP0GBJ05gUYBomKgRd07sVz5xax9hFYS1">


	<!--_footer 作为公共模版分离出去-->
	<script type="text/javascript" src="http://www.sycalc.com.cn:8082/lib/jquery/1.9.1/jquery.min.js"></script> 
	<script type="text/javascript" src="http://www.sycalc.com.cn:8082/lib/layer/2.4/layer.js"></script>
	<script type="text/javascript" src="http://www.sycalc.com.cn:8082/static/h-ui/js/H-ui.min.js"></script> 
	<script type="text/javascript" src="http://www.sycalc.com.cn:8082/static/h-ui.admin/js/H-ui.admin.js"></script> <!--/_footer 作为公共模版分离出去-->

	<!--请在下方写此页面业务相关的脚本-->
	
	<!-- 创建分组右侧模板 -->
	<script type="text/html" id="groupTpl">
		<div class="group-cons">
			<div class="group-con">
				<div class="group-conbox"></div>
				<button class="btn btn-primary radius js-add-project">
					<i class="Hui-iconfont"></i> 添加项目
				</button>
			</div>
			<div class="group-footer text-r">
				分组年份：<span class="mr-10">{{data.groupYear}}</span> 计项目数量：<span class="mr-10 js-count">0</span> 合计金额：<span class="js-money">0</span>（万元）
			</div>
		</div>
	</script>
	<!-- 搜索出的项目列表模板 -->
	<script type="text/html" id="projectListTpl">
		{{each data item index}}
		<div class="cl">
			<div class="check-box">
				<input data-id="{{item.id}}" data-money="{{item.money}}" data-name="{{item.name}}" type="checkbox" id="checkbox-{{index}}">
				<label for="checkbox-{{index}}">{{item.name}}</label>
			</div>
		</div>
		{{/each}}
	</script>
	<!-- 添加的子项目模板 -->
	<script type="text/html" id="projectConTpl">
		{{each data item index}}
		<button data-id="{{item.id}}" data-name="{{item.name}}" data-money="{{item.money}}" class="js-project btn btn-primary-outline radius" type="button">{{item.name}} <i class="Hui-iconfont js-project-delete">&#xe6a6</i></button>
		{{/each}}
	</script>
	
	
	<script type="text/javascript" src="lib/template/template.js"></script>
	<script>
		$(function(){
			var token = $("#token").val();

			var userId = 3;
			var group = {
				//获取部门
				getBm: function(){
					$.ajax({
						url: 'https://www.sycalc.com.cn/position/project-index',
						type: 'get',
						data: {"userId": userId},
						success: function(res){
							if(res.ok){
								var html = '';
								$.each(res.data, function(i, t){
									html += '<option value="'+ t.id +'">'+ t.name +'</option>';
								});
								$('#bmSelect').append(html);
							}
						}
					})
				},
				//获取分管领导
				getfgld: function(){
					$.ajax({
						url: 'https://www.sycalc.com.cn/user/get-secretary-list',
						type: 'get',
						success: function(res){
							if(res.ok){
								var html = '';
								$.each(res.data, function(i, t){
									html += '<option value="'+ t.id +'">'+ t.name +'</option>';
								});
								$('#fgldSelect').append(html);
							}
						}
					})
				}
			};
			group.getBm();
			group.getfgld();

			//统计当前分组的项目数量与金额
			function getCountMoney(){
				var box = $('.group-cons:visible'),
					projects = box.find('.js-project'),
					count = projects.length,
					money = 0;
				projects.each(function(){
					money += Number($(this).attr('data-money'));
				});
				box.find('.js-count').text(count);
				box.find('.js-money').text(money);
			};

			//分组切换
			$('#groupList').on('click', 'li', function(){
				var index = $(this).index();
				$(this).addClass('active').siblings().removeClass('active');
				$('.group-cons').eq(index).show().siblings().hide();
			});
			$('#groupList li:first').trigger('click');

			//删除分组
			$('#groupList').on('click', '.js-group-delete', function(e){
				e.stopPropagation();
				var _this = $(this);
				parent.layer.confirm('确定要删除该分组吗？', {
		    
				}, function(){
					var id = _this.parent().attr('data-id'),
						data = {
							"id": id
						};
					$.ajax({
						type: 'get',
						url: '/data/project.json',
						data: data,
						success: function(data){
							if(data.ok){
								_this.remove();
								layer.msg('删除成功!',{icon:1,time:1000});
							}
						}
					});
				}, function(){
				    
				});
			});

			//创建分组
			$('#createGroupBtn').on('click', function(){
				$('#bmSelect option:first').prop('selected', true);
				$('#fgldSelect option:first').prop('selected', true);
				$('#groupModal').modal();
			});
			//创建分组-确定
			$('#groupConfirm').on('click', function(){
				var groupNameTag = $('#groupName'),
					groupName = $.trim(groupNameTag.val());
				if(groupName == ''){
					groupNameTag.focus();
					layer.tips('请输入分组名称', '#groupConfirm', {
		                tips: [1, '#18a689'],
		                time: 1500
		            });
					return;
				};
				var groupYearTag = $('#groupYear'),
					groupYear = $.trim(groupYearTag.val());
				if(groupYear == ''){
					groupYearTag.focus();
					layer.tips('请输入分组年份', '#groupConfirm', {
		                tips: [1, '#18a689'],
		                time: 1500
		            });
					return;
				};
				var position = $('#bmSelect').val(),
					user = $('#fgldSelect').val();
				var data = {
					"_token": token,
					"groupName": groupName,
					"groupYear": groupYear,
					"position": position,
					"user": user
				};
				$.ajax({
					type: 'get',
					url: '/data/add.json',
					data: data,
					success: function(data){
						if(data.ok){
							layer.msg('创建成功!',{icon:1,time:1000});
							var liHtml = '<li data-year="'+ groupYear +'" data-id="'+ data.id +'">'+ groupName +'</li>';
							$('#groupList').append(liHtml);
							var html = template('groupTpl', {
				    			data: {"groupYear": groupYear}
				    		});
							$('#groupShow').append(html);
							$('#groupList li:last').trigger('click');
							$('#groupModal').modal('hide');
						}
					}
				});
			});
			
			var projectArr = [];
			//添加项目
			$('body').on('click', '.js-add-project', function(){
				$('#projectModal').modal();
				$('#projectInput').val('');
				$('#projectCheck').html('');
				projectArr = [];
				$(this).prev().find('.js-project').each(function(){
					var id = $(this).attr('data-id');
					projectArr.push(id);
				});
			});
			//删除子项目
			$('body').on('click', '.js-project-delete', function(){
				var _this = $(this).parent();
				parent.layer.confirm('确定要删除吗？', {
		    
				}, function(){
					var id = _this.attr('data-id'),
						data = {
							"id": id
						};
					$.ajax({
						type: 'get',
						url: '/data/project.json',
						data: data,
						success: function(data){
							if(data.ok){
								_this.remove();
								layer.msg('删除成功!',{icon:1,time:1000});
							}
						}
					});
				}, function(){
				    
				});
			});
			//搜索项目
			$('#projectSearch').on('click', function(){
				var value = $.trim($('#projectInput').val());
				if(value == ''){
					$('#projectInput').focus();
					return;
				};
				var year = $('#groupList li.active').attr('data-year'),
					data = {
						"keyword": value,
						"groupYear": year
					};
				$.ajax({
					type: 'get',
					url: '/data/project.json',
					data: data,
					success: function(data){
						if(data.ok){
							var html = template('projectListTpl', {
				    			data: data.list
				    		});
							$('#projectCheck').html(html);
							$('#projectCheck input').iCheck({
								checkboxClass: 'icheckbox-blue',
								radioClass: 'iradio-blue',
								increaseArea: '20%'
							});
							projectArr.forEach(function(item){
								$('#projectCheck input[data-id="'+ item +'"]').iCheck('check');
							});
						}
					}
				});
			});
			//项目输入框
			$('#projectInput').on('keyup', function(e){
				if(e.which == 13){
					$('#projectSearch').trigger('click');
				};
			});
			//项目确定
			$('#projectConfirm').on('click', function(){
				var check = $('#projectCheck input:checked');
				if(check.length == 0){
					layer.tips('请选择项目', '#projectConfirm', {
		                tips: [1, '#18a689'],
		                time: 1500
		            });
					return;
				};
				var ids = [],
					arr = [];
				check.each(function(){
					var _this = $(this),
						id = _this.attr('data-id'),
						name = _this.attr('data-name'),
						money = _this.attr('data-money');
					if(projectArr.indexOf(id) == -1){
						ids.push(id);
						var obj = {
							"id": id,
							"name": name,
							"money": money
						};
						arr.push(obj);
					};
				});
				if(ids.length == 0){
					$('#projectModal').modal('hide');
					return;
				};
				var data = {
					"ids": ids.join(',')
				};
				$.ajax({
					type: 'get',
					url: '/data/addProject.json',
					data: data,
					success: function(data){
						if(data.ok){
							$('#projectModal').modal('hide');
							var html = template('projectConTpl', {
				    			data: arr
				    		});
							$('.group-conbox:visible').append(html);
							getCountMoney();
						}
					}
				});
			});

		})
	</script>

</body>
</html>